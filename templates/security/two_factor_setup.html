{#
  This template receives different input based on state of tf-setup. In addition
  to form values the following are available:
  On GET:
    choices: Value of SECURITY_TWO_FACTOR_ENABLED_METHODS (with possible addition of 'delete'
    two_factor_required: Value of SECURITY_TWO_FACTOR_REQUIRED
  On successful POST:
    chosen_method: which 2FA method was chosen (e.g. sms, authenticator)
    choices: Value of SECURITY_TWO_FACTOR_ENABLED_METHODS

    If chosen_method == 'authenticator':
      authr_qrcode: the image source for the qrcode
      authr_key: same key as in qrcode - for possible manual entry
      authr_username: same username as in qrcode
      authr_issuer: same issuer as in qrcode
#}
{% extends "themes/" + sysSettings.systemTheme + "/layout.html" %}
{% from "security/_macros.html" import render_field_with_errors, render_field, render_field_no_label, render_field_errors %}

{% block head %}
<title>{{sysSettings.siteName}} - Configure Two-Factor Authentication</title>
{% endblock %}

{% block styles %}
    {{ super() }}
    <style type="text/css">
        .center { text-align: center }
        .important { font-size: larger; font-weight: bold }
    </style>
{% endblock %}

{% block body %}
<div class="login-box">
    <div class="branding d-flex justify-content-center">
        <div class="circular_image">
            <img src="{{sysSettings.systemLogo}}">
        </div>
    </div>
    <h2 class="title">Two-Factor Authentication Configuration</h2>
    <div class="mb-2">{{ _fsdomain("Two-factor authentication adds an extra layer of security to your account.") }}</div>
    <div class="mb-2">{{ _fsdomain("In addition to your email address and password, you'll need to use a code generated by your authenticator.") }}</div><br>
    <div class="my-2">
        <form action="{{ url_for_security("two_factor_setup") }}" method="POST" name="two_factor_setup_form" id="2faSelectorForm">
            {{ two_factor_setup_form.hidden_tag() }}
            <ul class="list-group">
                {% for subfield in two_factor_setup_form.setup %}
                    {% if subfield.data in choices %}
                        <li class="list-group-item">{{ render_field_with_errors(subfield) }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
            {{ render_field_errors(two_factor_setup_form.setup) }}
            <div class="d-grid gap-2">
                <input class="btn btn-primary boxShadow" id="2faSelect" name="submit" type="submit" value="Submit">
            </div>
        </form>
        {% if chosen_method=="authenticator" and chosen_method in choices %}
          <hr>
          <div class="center">
              <div>
                {{ _fsdomain("Open an authenticator app on your device and scan the following QRcode (or enter the code below manually) to start receiving codes:") }}
              </div>
              <div class="d-flex justify-content-center">
                  <img style="background-color: white;" alt="{{ _fsdomain("Two factor authentication code") }}" id="qrcode" src="{{ authr_qrcode }}">
              </div>
            <div class="d-flex justify-content-center">
              {{ authr_key }}
            </div>
          </div>
        <hr>
        <form id="2favalidation" action="{{ url_for_security("two_factor_token_validation") }}" method="POST"
              name="two_factor_verify_code_form">
            {{ two_factor_verify_code_form.hidden_tag() }}
            <div class="user-box">
                <input autocomplete="off" class="form-control" id="code" name="code" type="text" value="">
                <label for="code"><i class="fas fa-shield-alt"></i> Authentication Code</label>
            </div>
            <div class="d-grid gap-2">
                <input class="btn btn-primary boxShadow" id="submit" name="submit" type="submit" value="Save Token">
            </div>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}