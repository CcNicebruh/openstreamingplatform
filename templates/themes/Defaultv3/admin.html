{% extends "themes/" + sysSettings.systemTheme + "/layout.html" %}

{% from "themes/" + sysSettings.systemTheme + "/macros/shared.html" import live_stream_card, video_card, topic_card, nav_item_entry with context %}

{% block head %}
<title>{{sysSettings.siteName}}</title>
<meta name="twitter:card" content="app" />
<meta property="og:site_name" content="{{sysSettings.siteName}}" />
<meta property="og:title" content="{{sysSettings.siteName}}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{request.url|normalize_url}}" />
<meta property="og:image" content="{{request.url_root|normalize_urlroot}}/{{sysSettings.systemLogo}}" />

<script type="text/javascript" src="/static/vendor/chartjs/js/Chart.bundle.min.js"></script>
{% endblock %}

{% block body %}
    <div class="admin-nav">
        <ul class="nav" id="admin-nav-list" role="tablist">
            {{ nav_item_entry("Dashboard", True) }}
            {{ nav_item_entry("Settings", False) }}
            {{ nav_item_entry("OAuth", False) }}
            {{ nav_item_entry("RTMP", False) }}
            {{ nav_item_entry("Edge", False) }}
            {{ nav_item_entry("Webhooks", False) }}
            {{ nav_item_entry("Stickers", False) }}
            {{ nav_item_entry("Users", False) }}
            {{ nav_item_entry("Topics", False) }}
            {{ nav_item_entry("Channels", False) }}
            {{ nav_item_entry("Streams", False) }}
        </ul>
    </div>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active w-100" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
          <div class="row mt-4 mx-4">
            <div class="col-12 col-md-auto">
                <div id="osp-version" class="info-panel-box boxShadow osp-info-box box1-fill">
                    <div class="row">
                        <div class="col-2">
                            <img class="osplogo" src="/static/img/logo.png" alt="OSP Logo">
                        </div>
                        <div class="col-auto">
                            <span class="osp-title-box">
                                <span class="osp-title textShadow"><b>Open Streaming Platform</b></span><br>
                                <span class="osp-version"><b>Version: </b>{{sysSettings.version}}</span>
                            </span>
                        </div>
                    </div>
                    <div class="osp-info">
                        <a href="https://openstreamingplatform.com"><i class="bi bi-globe2"></i> https://openstreamingplatform.com</a><br>
                        <a href="https://gitlab.com/osp-group/flask-nginx-rtmp-manager"><i class="bi bi-file-code"></i> https://gitlab.com/osp-group/flask-nginx-rtmp-manager</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div id="osp-live-streams" class="info-panel-box boxShadow osp-live-streams-info-box green-fill">
                    <div class="info-panel-box-header-nofill"><b>Current Live Streams</b></div>
                    <div class="info-panel-box-metric"><b>5</b></div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div id="osp-live-viewers" class="info-panel-box boxShadow osp-live-viewers-info-box blue-fill">
                    <div class="info-panel-box-header-nofill"><b>Current Viewers</b></div>
                    <div class="info-panel-box-metric"><b>127</b></div>
                </div>
            </div>
        </div>
        <div class="row mt-4 mx-1">
            <div class="col-12 col-md-2">
                <div class="info-panel-box system-status-box">
                    <div class="info-panel-box-header boxShadow textShadow">
                        <b>System Status</b>
                    </div>
                    <div class="info-panel-box-body boxShadow">
                        <div id="system-status-ospcore" class="system-status-item"><b>OSP-Core</b></div>
                        <div id="system-status-osprtmp" class="system-status-item"><b>OSP-RTMP</b></div>
                        <div id="system-status-ospproxy" class="system-status-item"><b>OSP-Proxy</b></div>
                        <div id="system-status-ospedge" class="system-status-item"><b>OSP-Edge</b></div>
                        <div id="system-status-ejabberdchat" class="system-status-item"><b>Ejabberd-Chat</b></div>
                        <div id="system-status-ejabberdxmlrpc" class="system-status-item"><b>Ejabberd-XMLRPC</b></div>
                        <div id="system-status-database" class="system-status-item"><b>Database</b></div>
                        <div id="system-status-redis" class="system-status-item"><b>Redis</b></div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-10">
                <div class="info-panel-box">
                    <div class="info-panel-box-header boxShadow textShadow">
                        <b>Viewer Statistics</b>
                    </div>
                    <div class="info-panel-box-body boxShadow">
                        <div class="admin-viewerchart">
                            <div id="statChart">
                                <canvas id="viewershipChart" width="400" height="400"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4 mx-1">
            <div class="col-12">
                <div class="info-panel-box">
                    <div class="info-panel-box-header boxShadow textShadow">
                        <b>Channels Currently Live</b>
                    </div>
                    <div class="info-panel-box-body boxShadow">
                        <div class="admin-channelscurrentlylive">
                            <table class="table table-borderless">
                                <thead>
                                    <tr>
                                        <th>Channel Name</th>
                                        <th>Owner</th>
                                        <th>Topic</th>
                                        <th>Live Viewers</th>
                                        <th>Time Live</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stream in streamList %}
                                        <tr>
                                            <td>{{ stream.linkedChannel | get_channelName }}</td>
                                            <td>{{ stream.linkedChannel | channeltoOwnerID | get_userName }}</td>
                                            <td>{{ stream.topic | get_topicName }}</td>
                                            <td>{{ stream.currentViewers }}</td>
                                            <td>{{ stream.startTimestamp }}</td> <!--TODO TimeDelta and Update-->
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4 mx-1">
            <div class="col-12">
                <div class="info-panel-box">
                    <div class="info-panel-box-header boxShadow textShadow">
                        <b>Recent System Logs</b>
                    </div>
                    <div class="info-panel-box-body boxShadow">
                        <div class="admin-recentsystemlogs">
                            <table id="logTable" class="table table-borderless table-sm">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Type</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in logsList %}
                                        <tr>
                                            <td>{{log.timestamp|normalize_date}}</td>
                                            <td><span class="badge bg-secondary textShadow">{{log.type|get_logType}}</span></td>
                                            <td>{{log.message}}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">...</div>
      <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">...</div>
    </div>
{% endblock %}

{% block modals %}
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="/static/js/adminv2.js"></script>
<script type="text/javascript" src="/static/vendor/datatables/js/jquery.datatables.js"></script>
<script type="text/javascript" src="/static/vendor/datatables/js/datatables.js"></script>
<script>
    var viewerChartWidth = 1024;
    var viewerChartHeight = 380;
    var viewerChartDataLive = [
        {% for entry in statsViewsDay['live'] %}
            {x:'{{entry['t']}}',y:{{entry['y']}}},
        {% endfor %}
    ];
    var viewerChartDataVideo = [
        {% for entry in statsViewsDay['recorded'] %}
            {x:'{{entry['t']}}', y:{{entry['y']}}},
        {% endfor %}
    ];

    $(document).ready(function() {
        $('#logTable').DataTable({
            "order": [[ 0, "desc" ]]
        });
    } );
</script>
{% endblock %}